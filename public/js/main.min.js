"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var __DEV=!0,version=.001,compatible="9ICXM7PGXJ",__DOMAIN="example.com";String.prototype.toUpperCaseFirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Lib=function(){function Lib(){_classCallCheck(this,Lib)}return _createClass(Lib,null,[{key:"randString",value:function(length,lower,upper,numbers){var text="",possible="",possLower="abcdefghijklmnopqrstuvwxyz",possUpper="ABCDEFGHIJKLMNOPQRSTUVWXYZ";lower&&(possible+=possLower),upper&&(possible+=possUpper),numbers&&(possible+=posNum);for(var i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text}},{key:"weightedRandom",value:function(obj){var total=0;for(var key in obj)total+=obj[key];var r=Math.random()*total;for(var key in obj){if(r<obj[key])return key;r-=obj[key]}}},{key:"deepCopy",value:function(obj){return JSON.parse(JSON.stringify(obj))}},{key:"isObjEmpty",value:function(obj){if(null==obj)return!0;if(obj.length>0)return!1;if(0===obj.length)return!0;for(var key in obj)if(obj.hasOwnProperty(key))return!1;return!0}},{key:"socialMediaPost",value:function(site,url){"facebook"==site?window.open("http://www.facebook.com/share.php?u="+url,"Facebook","width=550,height=400"):"twitter"==site&&window.open("http://twitter.com/intent/tweet?status="+url,"Twitter","width=550,height=400")}}]),Lib}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),WebSocketClass=function(){function WebSocketClass(){_classCallCheck(this,WebSocketClass),this.server=0,this.connected=!1}return _createClass(WebSocketClass,[{key:"startWebSocket",value:function(){var _this=this;return!this.connected&&(__DEV?this.server=new WebSocket("ws://localhost:7777"):this.server=new WebSocket("ws://ws."+__DOMAIN+"/"),this.server.binaryType="arraybuffer",this.server.onopen=function(){_this.connected=!0,_this.sendObj({m:"compatible",v:compatible})},this.server.onclose=function(){_this.connected=!1,PO.ready=!1,$("#homepage").removeClass("hide"),$("#maingame").addClass("hide")},void(this.server.onmessage=function(e){var d=e.data;if("string"==typeof e.data)if(d=JSON.parse(d),console.log(d),"compatible"==d.m)0==d.v&&alert("Your game is out of date, try refreshing the browser.");else if("ready"==d.m)_this.sendObj({m:"start",n:PO.name,t:PO.type});else if("go"==d.m){Game.data.players.list=d.players,Game.data.myId=d.id,Game.data.map=d.map,Game.data.config.blocksize=d.block,Game.draw.map(),PO.ready=!0,$("#homepage").addClass("hide"),$("#maingame").removeClass("hide");d.id}else"ping"==d.m&&console.log(Date.now()-parseInt(d.v));else{var x=new Int8Array(d);if(7==x[0]){for(var playerData=new Int16Array(d),players=[],singlePlayer=[],i=2;i<playerData.length;i++)singlePlayer.push(playerData[i]),singlePlayer.length==playerData[1]&&(players.push(singlePlayer),singlePlayer=[]);Game.data.players.tick=players,Game.draw.players()}}}))}},{key:"stopWebSocket",value:function(){this.connected&&this.server.close()}},{key:"sendObj",value:function(object){return 0==this.connected?(alert("WebSocket is not connected."),!1):void this.server.send(JSON.stringify(object))}}]),WebSocketClass}(),WS=new WebSocketClass,PlayerOutput=function(){function PlayerOutput(){_classCallCheck(this,PlayerOutput),this.ready=!1,this.name="",this.type=0,this.chatMode=!1,this.chatText="",this.thrusterState=!1,this.weaponState=!1,this.thrust=function(on){on&&0==this.thrusterState?(PO.tick.thruster=1,PO.thrusterState=!0,PO.tickchanged=!0):on||1!=this.thrusterState||(1==PO.tick.thruster?PO.tick.thruster=3:PO.tick.thruster=2,PO.thrusterState=!1,PO.tickchanged=!0)},this.weapon=function(on){on&&0==this.weaponState?(PO.tick.weapon=1,PO.weaponState=!0,PO.tickchanged=!0):on||1!=this.weaponState||(1==PO.tick.weapon?PO.tick.weapon=3:PO.tick.weapon=2,PO.weaponState=!1,PO.tickchanged=!0)},this.tickEmpty=0,this.tickchanged=!1,this.tick={},this.tick.direction=this.tickEmpty,this.tick.thruster=this.tickEmpty,this.tick.weapon=this.tickEmpty,this.tick.message=this.tickEmpty,this.loopDelay=50,this.harvestLoop()}return _createClass(PlayerOutput,[{key:"harvestLoop",value:function(){var _this2=this;if(setTimeout(function(){setTimeout(function(){_this2.harvestLoop()},1)},this.loopDelay),this.tickchanged){var tickArray=[2];for(var key in this.tick)this.tick.hasOwnProperty(key)&&(tickArray.push(this.tick[key]),this.tick[key]=this.tickEmpty);WS.connected&&WS.sendObj(tickArray),this.tickchanged=!1}}}]),PlayerOutput}(),PO=new PlayerOutput,GameClass=function(){function GameClass(){var _this3=this;_classCallCheck(this,GameClass),this.center={x:$(window).width()/2,y:$(window).height()/2},this.view={x:3e3,y:1500},this.renderer=PIXI.autoDetectRenderer(this.view.x,this.view.y,{backgroundColor:0}),this.renderer.baseResolution={width:this.renderer.width,height:this.renderer.height},$("#maingame").append(this.renderer.view),this.data={},this.data.config={},this.data.map=[],this.data.players={tick:[],list:[]},this.data.myId=0,this.render={},this.render.world=new PIXI.Container,this.render.camera=new PIXI.Container,this.render.map=new PIXI.Graphics,this.render.players=new PIXI.Graphics,this.render.backgroundImage=PIXI.Texture.fromImage("images/colorfog.jpg"),this.render.background=new PIXI.extras.TilingSprite(this.render.backgroundImage,1e3,1e3),this.render.world.addChild(this.render.camera),this.render.camera.addChild(this.render.background),this.render.camera.addChild(this.render.map),this.render.camera.addChild(this.render.players),this.draw={},this.draw.map=function(){var blocksize=_this3.data.config.blocksize;_this3.render.background._width=blocksize*_this3.data.map.length,_this3.render.background._height=blocksize*_this3.data.map.length,_this3.render.map.clear(),_this3.data.map.forEach(function(element,index){element.forEach(function(e,i){if(0!=e){var offset={x:i*blocksize,y:index*blocksize};_this3.render.map.beginFill(_this3.color.numToColor(e)),_this3.render.map.alpha=1,_this3.render.map.lineStyle(6,16777215,1),_this3.render.map.moveTo(offset.x+0,offset.y+0),_this3.render.map.lineTo(offset.x+0,offset.y+blocksize),_this3.render.map.lineTo(offset.x+blocksize,offset.y+blocksize),_this3.render.map.lineTo(offset.x+blocksize,offset.y+0),_this3.render.map.lineTo(offset.x+0,offset.y+0),_this3.render.map.endFill()}})})},this.draw.players=function(){var ship={width:40,height:60},shipX={point:ship.height/3*2,left:-(ship.height/3),right:-(ship.height/3)},shipY={point:0,left:-(ship.width/2),right:ship.width/2};_this3.render.players.clear(),_this3.data.players.tick.forEach(function(e,i){var offset={x:e[1],y:e[2],r:e[3]/1e3};_this3.render.players.beginFill("0x00ff00"),_this3.render.players.alpha=1,_this3.render.players.lineStyle(6,16777215,1),_this3.render.players.moveTo(offset.x+(shipX.point*Math.cos(offset.r)-shipY.point*Math.sin(offset.r)),offset.y+(shipX.point*Math.sin(offset.r)+shipY.point*Math.cos(offset.r))),_this3.render.players.lineTo(offset.x+(shipX.left*Math.cos(offset.r)-shipY.left*Math.sin(offset.r)),offset.y+(shipX.left*Math.sin(offset.r)+shipY.left*Math.cos(offset.r))),_this3.render.players.lineTo(offset.x+(shipX.right*Math.cos(offset.r)-shipY.right*Math.sin(offset.r)),offset.y+(shipX.right*Math.sin(offset.r)+shipY.right*Math.cos(offset.r))),_this3.render.players.lineTo(offset.x+(shipX.point*Math.cos(offset.r)-shipY.point*Math.sin(offset.r)),offset.y+(shipX.point*Math.sin(offset.r)+shipY.point*Math.cos(offset.r))),_this3.render.players.endFill(),e[0]==_this3.data.myId&&(_this3.render.camera.position.x=-offset.x+Game.view.x/2,_this3.render.camera.position.y=-offset.y+Game.view.y/2)})},this.color={},this.color.componentToHex=function(c){var hex=c.toString(16);return 1==hex.length?"0"+hex:hex},this.color.rgbToHex=function(r,g,b){return"0x"+_this3.color.componentToHex(r)+_this3.color.componentToHex(g)+_this3.color.componentToHex(b)},this.color.numToColor=function(num){var colors=["0xffffff","0x800080","0x0000ff","0x00ff00","0xffff00","0xe67e22","0xff0000"];return"undefined"!=typeof colors[num]?colors[num]:colors[0]},this.color.randHex=function(){return _this3.color.rgbToHex(Math.floor(256*Math.random()),Math.floor(256*Math.random()),Math.floor(256*Math.random()))},$(window).on("resize",function(){var width=$(window).width(),height=$(window).height();_this3.center={x:width/2,y:height/2},_this3.renderer.resize(width,height);var scale={};scale.w=width/_this3.renderer.baseResolution.width,scale.h=height/_this3.renderer.baseResolution.height,scale.largest=scale.w,scale.smallest=scale.h,scale.orentation="landscape",scale.h>scale.w&&(scale.largest=scale.h,scale.smallest=scale.w,scale.orentation="portrait"),scale.difference=scale.largest-scale.smallest,_this3.render.world.scale.x=scale.largest,_this3.render.world.scale.y=scale.largest,_this3.render.world.position.x=0,_this3.render.world.position.y=0,"portrait"==scale.orentation?_this3.render.world.position.x-=_this3.renderer.baseResolution.width*scale.difference/2:_this3.render.world.position.y-=_this3.renderer.baseResolution.height*scale.difference/2}),$(window).trigger("resize"),this.animate()}return _createClass(GameClass,[{key:"animate",value:function(){var _this4=this;requestAnimationFrame(function(){_this4.animate()}),this.renderer.render(this.render.world)}}]),GameClass}(),Game=new GameClass;$("#enter-name-input").on("keyup",function(){PO.name=$(this).val()}),$(".type-button").on("click",function(){PO.type=$(this).attr("data-value"),WS.startWebSocket()}),$(window).on("mousedown",function(e){return!PO.ready||void(0==e.button?PO.weapon(!0):2==e.button&&PO.thrust(!0))}),$(window).on("mouseup",function(e){return!PO.ready||void(0==e.button?PO.weapon(!1):2==e.button&&PO.thrust(!1))}),$(window).on("keydown",function(e){return!PO.ready||void(13==e.keyCode?PO.chatMode?(PO.tick.message=PO.chatText,PO.tickchanged=!0,PO.chatMode=!1,PO.chatText=""):PO.chatMode=!0:PO.chatMode?(e.keyCode>31&&e.keyCode<127&&(PO.chatText+=e.key),8==e.keyCode&&(PO.chatText=PO.chatText.slice(0,-1))):87==e.keyCode?PO.weapon(!0):32==e.keyCode&&PO.thrust(!0))}),$(window).on("keyup",function(e){return!PO.ready||void(PO.chatMode||(87==e.keyCode?PO.weapon(!1):32==e.keyCode&&PO.thrust(!1)))}),$(window).on("mousemove",function(e){if(!PO.ready)return!0;var mouse={X:e.clientX,Y:e.clientY},screen={W:$(window).width(),H:$(window).height()},delta={X:mouse.X-screen.W/2,Y:mouse.Y-screen.H/2},rad=Math.atan2(delta.Y,delta.X);PO.tick.direction=Math.floor(1e3*rad),PO.tickchanged=!0});