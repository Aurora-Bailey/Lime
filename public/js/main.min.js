"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var __DEV=!0,version=.001,compatible="9ICXM7PGXJ",__DOMAIN="example.com";String.prototype.toUpperCaseFirst=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Lib=function(){function Lib(){_classCallCheck(this,Lib)}return _createClass(Lib,null,[{key:"randString",value:function(length,lower,upper,numbers){var text="",possible="",possLower="abcdefghijklmnopqrstuvwxyz",possUpper="ABCDEFGHIJKLMNOPQRSTUVWXYZ";lower&&(possible+=possLower),upper&&(possible+=possUpper),numbers&&(possible+=posNum);for(var i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text}},{key:"weightedRandom",value:function(obj){var total=0;for(var key in obj)total+=obj[key];var r=Math.random()*total;for(var key in obj){if(r<obj[key])return key;r-=obj[key]}}},{key:"deepCopy",value:function(obj){return JSON.parse(JSON.stringify(obj))}},{key:"isObjEmpty",value:function(obj){if(null==obj)return!0;if(obj.length>0)return!1;if(0===obj.length)return!0;for(var key in obj)if(obj.hasOwnProperty(key))return!1;return!0}},{key:"numToColorNameProper",value:function(num){var colors=["White","Purple","Blue","Green","Yellow","Orange","Red"];return"undefined"!=typeof colors[num]?colors[num]:colors[0]}},{key:"socialMediaPost",value:function(site,url){"facebook"==site?window.open("http://www.facebook.com/share.php?u="+url,"Facebook","width=550,height=400"):"twitter"==site&&window.open("http://twitter.com/intent/tweet?status="+url,"Twitter","width=550,height=400")}}]),Lib}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),WebSocketClass=function(){function WebSocketClass(){_classCallCheck(this,WebSocketClass),this.server=0,this.connected=!1}return _createClass(WebSocketClass,[{key:"startWebSocket",value:function(){var _this=this;return!this.connected&&(__DEV?this.server=new WebSocket("ws://localhost:7777"):this.server=new WebSocket("ws://ws."+__DOMAIN+"/"),this.server.binaryType="arraybuffer",this.server.onopen=function(){_this.connected=!0,_this.sendObj({m:"compatible",v:compatible})},this.server.onclose=function(){_this.connected=!1,PO.ready=!1,$("#homepage").removeClass("hide"),$("#maingame").addClass("hide"),$("#chat-log").addClass("hide")},void(this.server.onmessage=function(e){var d=e.data;if("string"==typeof e.data)if(d=JSON.parse(d),console.log(d),"compatible"==d.m)0==d.v&&alert("Your game is out of date, try refreshing the browser.");else if("ready"==d.m)_this.sendObj({m:"start",n:PO.name,t:PO.type});else if("go"==d.m){Game.data.players.list=d.players,Game.data.myId=d.id,Game.data.map=d.map,Game.data.config.blocksize=d.block,Game.draw.map(),PO.ready=!0,$("#homepage").addClass("hide"),$("#maingame").removeClass("hide"),$("#chat-log").removeClass("hide"),$("#chat-log").html("").prepend($("<div />").addClass("game").text("Press [Enter] to open/close chat.")),$("#chat-log").prepend($("<div />").addClass("game").text("You can only chat with "+Lib.numToColorNameProper(Game.data.players.list["p"+Game.data.myId].color)+" players."));d.id}else"dead"==d.m?($("#respawn").removeClass("hide"),$("#chat-log").prepend($("<div />").addClass("game").text("You're Dead!"))):"killed"==d.m?$("#chat-log").prepend($("<div />").addClass("game").text("You killed '"+d.v+"'")):"dcplayer"==d.m?"undefined"!=typeof Game.data.players.list["p"+d.v]&&delete Game.data.players.list["p"+d.v]:"newplayer"==d.m?Game.data.players.list["p"+d.v.id]=d.v:"oom"==d.m?$("#chat-log").prepend($("<div />").addClass("game").text("You've sent too many messages (try again in 10 seconds)")):"tm"==d.m&&$("#chat-log").prepend($("<div />").addClass("team").addClass(Lib.numToColorNameProper(Game.data.players.list["p"+Game.data.myId].color).toLowerCase()).text("[ "+Game.data.players.list["p"+d.id].name+" ]  "+d.v));else{var x=new Int8Array(d);if(7==x[0]&&(Game.data.players.tick=WS.unpackBinary(d,16),Game.draw.players()),8==x[0]&&(Game.data.lasers=Game.data.lasers.concat(WS.unpackBinary(d,16)),Game.draw.lasers()),9==x[0]){var blockChages=WS.unpackBinary(d,16);blockChages.forEach(function(e,i){var mapX=e[0],mapY=e[1];Game.data.map[mapY][mapX]=e[2]}),Game.draw.map()}}}))}},{key:"unpackBinary",value:function(data,bitSize){var binaryData=!1;8==bitSize&&(binaryData=new Int8Array(data)),16==bitSize&&(binaryData=new Int16Array(data)),32==bitSize&&(binaryData=new Int32Array(data));for(var currentDate=Date.now(),mainArray=[],singleArray=[],k=2;k<binaryData.length;k++)singleArray.push(binaryData[k]),singleArray.length==binaryData[1]&&(singleArray.push(currentDate),mainArray.push(singleArray),singleArray=[]);return mainArray}},{key:"stopWebSocket",value:function(){this.connected&&this.server.close()}},{key:"sendObj",value:function(object){return 0==this.connected?(alert("WebSocket is not connected."),!1):void this.server.send(JSON.stringify(object))}}]),WebSocketClass}(),WS=new WebSocketClass,PlayerOutput=function(){function PlayerOutput(){_classCallCheck(this,PlayerOutput),this.ready=!1,this.name="",this.type=0,this.chatMode=!1,this.thrusterState=!1,this.weaponState=!1,this.tickEmpty=0,this.tickchanged=!1,this.tick={},this.tick.direction=this.tickEmpty,this.tick.thruster=this.tickEmpty,this.tick.weapon=this.tickEmpty,this.tick.message=this.tickEmpty,this.loopDelay=50,this.harvestLoop()}return _createClass(PlayerOutput,[{key:"thrust",value:function(on){on&&0==this.thrusterState?(PO.tick.thruster=1,PO.thrusterState=!0,PO.tickchanged=!0):on||1!=this.thrusterState||(1==PO.tick.thruster?PO.tick.thruster=3:PO.tick.thruster=2,PO.thrusterState=!1,PO.tickchanged=!0)}},{key:"weapon",value:function(on){on&&0==this.weaponState?(PO.tick.weapon=1,PO.weaponState=!0,PO.tickchanged=!0):on||1!=this.weaponState||(1==PO.tick.weapon?PO.tick.weapon=3:PO.tick.weapon=2,PO.weaponState=!1,PO.tickchanged=!0)}},{key:"harvestLoop",value:function(){var _this2=this;if(setTimeout(function(){setTimeout(function(){_this2.harvestLoop()},1)},this.loopDelay),this.tickchanged){var tickArray=[2];for(var key in this.tick)this.tick.hasOwnProperty(key)&&(tickArray.push(this.tick[key]),this.tick[key]=this.tickEmpty);WS.connected&&WS.sendObj(tickArray),this.tickchanged=!1}}}]),PlayerOutput}(),PO=new PlayerOutput,GameClass=function(){function GameClass(){var _this3=this;_classCallCheck(this,GameClass),this.center={x:$(window).width()/2,y:$(window).height()/2},this.view={x:2e3,y:1e3},this.zoomLevel=4,this.renderer=PIXI.autoDetectRenderer(this.view.x,this.view.y,{backgroundColor:0}),this.renderer.baseResolution={width:this.renderer.width,height:this.renderer.height},$("#maingame").append(this.renderer.view),this.rendererMinimap=PIXI.autoDetectRenderer(400,400,{backgroundColor:0}),this.rendererMinimap.baseResolution={width:this.rendererMinimap.width,height:this.rendererMinimap.height},$("#minimap").append(this.rendererMinimap.view),this.data={},this.data.config={},this.data.map=[],this.data.players={tick:[],list:[]},this.data.lasers=[],this.data.myId=0,this.render={},this.render.world=new PIXI.Container,this.render.camera=new PIXI.Container,this.render.text=new PIXI.Container,this.render.map=new PIXI.Graphics,this.render.players=new PIXI.Graphics,this.render.lasers=new PIXI.Graphics,this.render.miniworld=new PIXI.Container,this.render.minimap=new PIXI.Graphics,this.render.miniplayers=new PIXI.Graphics,this.render.backgroundImage=PIXI.Texture.fromImage("images/colorfog.jpg"),this.render.background=new PIXI.extras.TilingSprite(this.render.backgroundImage,1e3,1e3),this.render.names=[],this.render.world.addChild(this.render.camera),this.render.camera.addChild(this.render.background),this.render.camera.addChild(this.render.map),this.render.camera.addChild(this.render.players),this.render.camera.addChild(this.render.lasers),this.render.camera.addChild(this.render.text),this.render.miniworld.addChild(this.render.minimap),this.render.miniworld.addChild(this.render.miniplayers),this.draw={},this.draw.map=function(){var blocksize=_this3.data.config.blocksize;_this3.render.background._width=blocksize*_this3.data.map.length,_this3.render.background._height=blocksize*_this3.data.map.length,_this3.render.map.clear(),_this3.data.map.forEach(function(element,index){element.forEach(function(e,i){if(0!=e){var offset={x:i*blocksize,y:index*blocksize},border=6;_this3.render.map.beginFill("0xffffff"),_this3.render.map.alpha=1,_this3.render.map.lineStyle(0,16777215,1),_this3.render.map.moveTo(offset.x+0,offset.y+0),_this3.render.map.lineTo(offset.x+0,offset.y+blocksize),_this3.render.map.lineTo(offset.x+blocksize,offset.y+blocksize),_this3.render.map.lineTo(offset.x+blocksize,offset.y+0),_this3.render.map.lineTo(offset.x+0,offset.y+0),_this3.render.map.endFill(),_this3.render.map.beginFill(_this3.color.numToColor(e)),_this3.render.map.alpha=1,_this3.render.map.lineStyle(0,16777215,1),_this3.render.map.moveTo(offset.x+border,offset.y+border),_this3.render.map.lineTo(offset.x+border,offset.y+blocksize-border),_this3.render.map.lineTo(offset.x+blocksize-border,offset.y+blocksize-border),_this3.render.map.lineTo(offset.x+blocksize-border,offset.y+border),_this3.render.map.lineTo(offset.x+border,offset.y+border),_this3.render.map.endFill(),21==e?(_this3.render.map.lineStyle(10,0,1),_this3.render.map.moveTo(offset.x+border,offset.y+border),_this3.render.map.lineTo(offset.x+blocksize-border,offset.y+blocksize-border)):22==e?(_this3.render.map.lineStyle(10,0,1),_this3.render.map.moveTo(offset.x+blocksize-border,offset.y+blocksize-border),_this3.render.map.lineTo(offset.x+border,offset.y+border),_this3.render.map.moveTo(offset.x+border,offset.y+blocksize-border),_this3.render.map.lineTo(offset.x+blocksize-border,offset.y+border)):23==e&&(_this3.render.map.lineStyle(10,0,1),_this3.render.map.moveTo(offset.x+border,offset.y+blocksize-border),_this3.render.map.lineTo(offset.x+blocksize-border,offset.y+border))}})}),_this3.draw.minimap()},this.draw.minimap=function(){var blocksize=_this3.rendererMinimap.baseResolution.width/_this3.data.map.length;_this3.render.minimap.clear(),_this3.data.map.forEach(function(element,index){element.forEach(function(e,i){if(0!=e){var offset={x:i*blocksize,y:index*blocksize};_this3.render.minimap.beginFill("0x333333"),_this3.render.minimap.alpha=1,_this3.render.minimap.lineStyle(0,16777215,1),_this3.render.minimap.moveTo(offset.x+0,offset.y+0),_this3.render.minimap.lineTo(offset.x+0,offset.y+blocksize),_this3.render.minimap.lineTo(offset.x+blocksize,offset.y+blocksize),_this3.render.minimap.lineTo(offset.x+blocksize,offset.y+0),_this3.render.minimap.lineTo(offset.x+0,offset.y+0),_this3.render.minimap.endFill()}})})},this.draw.players=function(){var ship={width:40,height:60},shipX={point:ship.height/3*2,left:-(ship.height/3),right:-(ship.height/3)},shipY={point:0,left:-(ship.width/2),right:ship.width/2};_this3.render.players.clear(),_this3.render.names.forEach(function(e,i){_this3.render.names[i].text=""}),_this3.data.players.tick.forEach(function(e,i){if(0==e[4])return!1;var offset={x:e[1],y:e[2],r:e[3]/1e3},id=e[0],player=_this3.data.players.list["p"+id];"undefined"==typeof _this3.render.names[i]&&(_this3.render.names[i]=new PIXI.Text("",{font:"bold 30px Arial",fill:"white",align:"center",stroke:"#000000",strokeThickness:6}),_this3.render.names[i].anchor.set(.5),_this3.render.text.addChild(_this3.render.names[i])),_this3.render.names[i].text=player.name,_this3.render.names[i].position.x=offset.x,_this3.render.names[i].position.y=offset.y-100,_this3.render.players.beginFill("0xff0000"),_this3.render.players.lineStyle(3,0,1),_this3.render.players.drawRect(offset.x-50,offset.y-80,100,10),_this3.render.players.endFill(),_this3.render.players.beginFill("0x00ff00"),_this3.render.players.lineStyle(3,0,1),_this3.render.players.drawRect(offset.x-50,offset.y-80,e[4],10),_this3.render.players.endFill(),_this3.render.players.beginFill(_this3.color.numToColor(player.color)),_this3.render.players.alpha=1,_this3.render.players.lineStyle(6,16777215,1),_this3.render.players.moveTo(offset.x+(shipX.point*Math.cos(offset.r)-shipY.point*Math.sin(offset.r)),offset.y+(shipX.point*Math.sin(offset.r)+shipY.point*Math.cos(offset.r))),_this3.render.players.lineTo(offset.x+(shipX.left*Math.cos(offset.r)-shipY.left*Math.sin(offset.r)),offset.y+(shipX.left*Math.sin(offset.r)+shipY.left*Math.cos(offset.r))),_this3.render.players.lineTo(offset.x+(shipX.right*Math.cos(offset.r)-shipY.right*Math.sin(offset.r)),offset.y+(shipX.right*Math.sin(offset.r)+shipY.right*Math.cos(offset.r))),_this3.render.players.lineTo(offset.x+(shipX.point*Math.cos(offset.r)-shipY.point*Math.sin(offset.r)),offset.y+(shipX.point*Math.sin(offset.r)+shipY.point*Math.cos(offset.r))),_this3.render.players.endFill(),e[0]==_this3.data.myId&&(_this3.render.camera.position.x=-offset.x+Game.view.x/2,_this3.render.camera.position.y=-offset.y+Game.view.y/2)}),_this3.draw.miniplayers()},this.draw.miniplayers=function(){var blocksize=_this3.rendererMinimap.baseResolution.width/_this3.data.map.length,scale=blocksize/_this3.data.config.blocksize;_this3.render.miniplayers.clear(),_this3.data.players.tick.forEach(function(e,i){if(0==e[4])return!1;if(e[0]==_this3.data.myId){var offset={x:e[1]*scale,y:e[2]*scale},id=e[0],player=_this3.data.players.list["p"+id];_this3.render.miniplayers.beginFill(_this3.color.numToColor(player.color)),_this3.render.miniplayers.alpha=1,_this3.render.miniplayers.lineStyle(4,16777215,1),_this3.render.miniplayers.drawCircle(offset.x,offset.y,10),_this3.render.miniplayers.endFill()}})},this.draw.lasers=function(){var frameTime=Date.now(),laserTimeout=100;_this3.render.lasers.clear();for(var i=0;i<_this3.data.lasers.length;i++){var age=frameTime-_this3.data.lasers[i][5];age>laserTimeout&&(_this3.data.lasers.splice(i,1),i--)}_this3.data.lasers.forEach(function(e,i){var offset={x1:e[0],y1:e[1],x2:e[2],y2:e[3]},age=(e[4],frameTime-e[5]);_this3.render.lasers.lineStyle(10*(1-age/laserTimeout),16777215,1),_this3.render.lasers.moveTo(offset.x1,offset.y1),_this3.render.lasers.lineTo(offset.x2,offset.y2)})},this.color={},this.color.componentToHex=function(c){var hex=c.toString(16);return 1==hex.length?"0"+hex:hex},this.color.rgbToHex=function(r,g,b){return"0x"+_this3.color.componentToHex(r)+_this3.color.componentToHex(g)+_this3.color.componentToHex(b)},this.color.numToColor=function(num){var colors=["0xffffff","0x800080","0x0000ff","0x00ff00","0xffff00","0xe67e22","0xff0000"];return"undefined"!=typeof colors[num]?colors[num]:colors[0]},this.color.randHex=function(){return _this3.color.rgbToHex(Math.floor(256*Math.random()),Math.floor(256*Math.random()),Math.floor(256*Math.random()))},$(window).on("resize",function(){var minimapWidth=$("#minimap").width(),minimapHeight=$("#minimap").height();_this3.rendererMinimap.resize(minimapWidth,minimapHeight),_this3.render.miniworld.scale.x=minimapWidth/_this3.rendererMinimap.baseResolution.width,_this3.render.miniworld.scale.y=minimapHeight/_this3.rendererMinimap.baseResolution.height;var width=$(window).width(),height=$(window).height();_this3.center={x:width/2,y:height/2},_this3.renderer.resize(width,height);var scale={};scale.w=width/_this3.renderer.baseResolution.width,scale.h=height/_this3.renderer.baseResolution.height,scale.largest=scale.w,scale.smallest=scale.h,scale.orentation="landscape",scale.h>scale.w&&(scale.largest=scale.h,scale.smallest=scale.w,scale.orentation="portrait"),scale.difference=scale.largest-scale.smallest,_this3.render.world.scale.x=scale.largest,_this3.render.world.scale.y=scale.largest,_this3.render.world.position.x=0,_this3.render.world.position.y=0,"portrait"==scale.orentation?_this3.render.world.position.x-=_this3.renderer.baseResolution.width*scale.difference/2:_this3.render.world.position.y-=_this3.renderer.baseResolution.height*scale.difference/2}),this.zoom(this.zoomLevel),this.animate()}return _createClass(GameClass,[{key:"zoom",value:function(x){1==x?(this.renderer.baseResolution.width=1500,this.renderer.baseResolution.height=750,this.view.x=1500,this.view.y=750):2==x?(this.renderer.baseResolution.width=2e3,this.renderer.baseResolution.height=1e3,this.view.x=2e3,this.view.y=1e3):3==x?(this.renderer.baseResolution.width=2500,this.renderer.baseResolution.height=1250,this.view.x=2500,this.view.y=1250):(this.renderer.baseResolution.width=3e3,this.renderer.baseResolution.height=1500,this.view.x=3e3,this.view.y=1500),this.zoomLevel=x,$(window).trigger("resize")}},{key:"animate",value:function(){var _this4=this;requestAnimationFrame(function(){_this4.animate()}),this.draw.lasers(),this.renderer.render(this.render.world),this.rendererMinimap.render(this.render.miniworld)}}]),GameClass}(),Game=new GameClass;$("#enter-name-input").on("keyup",function(){PO.name=$(this).val()}),$(".type-button").on("click",function(){PO.type=$(this).attr("data-value"),WS.startWebSocket()}),$("#respawn-button").on("click",function(){WS.connected&&WS.server.send(JSON.stringify({m:"respawn"})),$("#respawn").addClass("hide")}),$("#respawn-leave").on("click",function(){WS.connected&&WS.server.close(),$("#respawn").addClass("hide")}),$(window).on("mousedown",function(e){return!PO.ready||void(0==e.button?PO.weapon(!0):2==e.button&&PO.thrust(!0))}),$(window).on("mouseup",function(e){return!PO.ready||void(0==e.button?PO.weapon(!1):2==e.button&&PO.thrust(!1))}),$(window).on("keydown",function(e){return!PO.ready||(PO.chatMode||(87==e.keyCode?PO.weapon(!0):32==e.keyCode&&PO.thrust(!0)),13!=e.keyCode&&9!=e.keyCode&&void 0)}),$(window).on("keyup",function(e){return!PO.ready||(PO.chatMode||(87==e.keyCode?PO.weapon(!1):32==e.keyCode&&PO.thrust(!1)),13==e.keyCode||9==e.keyCode?(PO.chatMode?(PO.tick.message=$("#actual-chat-box").val(),PO.tickchanged=!0,PO.chatMode=!1,$("#enter-chat").addClass("hide"),$("#actual-chat-box").blur().val("")):(PO.chatMode=!0,$("#enter-chat").removeClass("hide"),$("#actual-chat-box").focus()),!1):void 0)}),$(window).on("mousemove",function(e){if(!PO.ready)return!0;var mouse={X:e.clientX,Y:e.clientY},screen={W:$(window).width(),H:$(window).height()},delta={X:mouse.X-screen.W/2,Y:mouse.Y-screen.H/2},rad=Math.atan2(delta.Y,delta.X);PO.tick.direction=Math.floor(1e3*rad),PO.tickchanged=!0});